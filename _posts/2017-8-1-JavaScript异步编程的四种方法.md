---
title: JavaScript异步编程四种方法

---

#### 背景
我们知道JavaScript执行环境是单线程的。所谓“单线程”就是指一次只能完成一件任务。如果有多个任务，就必须排队，前面一个任务完成，再执行后面一个任务，
以此类推。

这种模式的好处是实现起来比较简单，执行环境相对单纯；坏处是只要有一个任务耗时很长，后面的任务都必须排队等着，会拖延整个程序的执行。常见的浏览器无响应（假死），
往往就是因为某一段Javascript代码长时间运行（比如死循环），导致整个页面卡在这个地方，其他任务无法执行。

为了解决这个问题，Javascript语言将任务的执行模式分成两种：同步（Synchronous）和异步（Asynchronous）

"同步模式"就是上一段的模式，后一个任务等待前一个任务结束，然后再执行，程序的执行顺序与任务的排列顺序是一致的、同步的；"异步模式"则完全不同，
每一个任务有一个或多个回调函数（callback），前一个任务结束后，不是执行后一个任务，而是执行回调函数，后一个任务则是不等前一个任务结束就执行，
所以程序的执行顺序与任务的排列顺序是不一致的、异步的。

"异步模式"非常重要。在浏览器端，耗时很长的操作都应该异步执行，避免浏览器失去响应，最好的例子就是Ajax操作。在服务器端，"异步模式"甚至是唯一的模式
，因为执行环境是单线程的，如果允许同步执行所有http请求，服务器性能会急剧下降，很快就会失去响应。

本文总结了"异步模式"编程的4种方法，理解它们可以让你写出结构更合理、性能更出色、维护更方便的Javascript程序。

----------------------------------
#### 回调函数
1. ##### script 标签

这是最原始的JavaScript文件加载方式。

早期为了解决这些弊端一些复杂的框架会使用命名空间来组织这些模块接口，典型的YUI库。
这个过程https://github.com/seajs/seajs/issues/547这篇博客讲的不错，可以了解。

这种方式暴露显而易见弊端：
* 全局作用域下变量冲突
* 文件只能按照script 标签书写顺序进行加载
* 开发必须主观解决模块间的依赖关系
* 在大型项目中各种资源难以管理，长期积累的问题导致代码库混乱不堪。

2. ##### CommonJS
详情见我的博客 [commonJS规范](https://gitxiangzhang.github.io/xiangzhang.github.io/2016/04/29/CommonJS%E8%A7%84%E8%8C%83.html)

缺点：
* 同步加载模式不适用于浏览器
* 不能非阻塞并行多个加载

3. ##### AMD
详情见我的博客 [AMD](https://gitxiangzhang.github.io/xiangzhang.github.io/2016/04/30/AMD%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD.html)

4. ##### CMD
5. ##### ES6module

----------------------------------
#### 期望的模块系统
1. 前端模块要在浏览器执行，所以他们需要增量加载到浏览器中。模块的传输和加载 我们首先能想到两种极端的方式，一种是把所有模块都打包到一个文件中只请求一次，
另一种是每个模块文件都单独请求，显而易见两种方式都不够完善，请求过多会启动变慢，一次请求全部，暂时用不到的模块也请求过来了，导致流量浪费
响应也会变慢。
我们所期望的一种模式是：按需进行懒加载，在实际用到某些模块的时候在进行增量跟新。

2. 可以兼容样式，图片，字体等众多类型模块资源。

如何做到我们期望的： 在编译阶段，对整个代码进行静态分析，分析出各个模块的类型和他们的依赖关系，然后将不同类型的模块提交给适配的加载器处理
比如一个用less 写的样式模块，可以先用less 加载器将他转换成 css模块，再通过css模块把他插入到页面的 style 标签中执行。webpack 就在这样的需求中
诞生。



----------------------------------
#### webpack
webpack 是一个模块打包器，他将根据模块的依赖关系进行静态分析，然后将这些模块按照指定的规则生成对应的静态资源。

![webpack2]({{ site.baseurl }}/images/webpack2.jpg)

这里提一下webpack和grunt gulp 有什么不一样：

grunt 和 gulp 的工作方式是 ：Grunt和Gulp的工作方式是：在一个配置文件中，指明对某些文件进行类似编译，组合，压缩等任务的具体步骤，这个工具之后可以自动替你完成这些任务。

![webpack1]({{ site.baseurl }}/images/webpack1.jpg)

Webpack的工作方式是：把你的项目当做一个整体，通过一个给定的主文件（如：index.js），Webpack将从这个文件开始找到你的项目的所有依赖文件，使用loaders处理它们，最后打包为一个浏览器可识别的JavaScript文件。

----------------------------------
#### webpack特点
1. ##### 代码拆分

webpack有两种组织模块依赖的方式，同步和异步。详情见 [webpack Code Splitting](https://gitxiangzhang.github.io/xiangzhang.github.io/2017/07/22/webpack-code-splitting.html)

2. ##### loader

loder转换器可以将各种类型资源转换成JavaScript模块。这样任何资源都可以成为webpack可以处理的模块了。

3. ##### 智能解析

webpack 可以处理几乎所有第三方库，无论他们是CommonJS ，AMD 还是普通js文件，加载的时候可以用动态表达式。

4. ##### 插件系统

webpack 有丰富的插件系统。

5. ##### 快速运行

webpack 使用异步i/o 和多级缓存提高运行效率。使得webpack 能够以难以置信的速度增量编译。


----------------------------------
#### webpack 安装
全局：npm i webpack -g

本地：npm i webpack --save-dev


----------------------------------
#### webpack 具体详解 见 [webpack demo详解](https://gitxiangzhang.github.io/xiangzhang.github.io/2017/07/20/webpack-%E6%95%B4%E7%90%86.html)
